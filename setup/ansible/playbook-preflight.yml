---

- hosts: all
  become: yes
  gather_facts: yes

  vars_files:
    - vars.yml

  pre_tasks:
    # Work-around for Buster 2019-06-24 release
    - name: Allow Release Info Change
      shell: apt-get update --allow-releaseinfo-change
      args:
        warn: false

    - name: Upgrade system
      apt:
        upgrade: dist
        # Need the force_apt_get until
        # https://github.com/ansible/ansible/issues/56832
        force_apt_get: yes
      register: apt_upgrade
      retries: 5
      until: apt_upgrade is success

    - name: Upgrade all packages to the latest version
      apt:
        name: "*"
        state: latest
        # Need the force_apt_get until
        # https://github.com/ansible/ansible/issues/56832
        force_apt_get: yes
      register: apt_update
      retries: 5
      until: apt_update is success

  tasks:
    - include_role:
        name: system
      tags: ['system']

    - include_role:
        name: user
      tags: ['user']

    - name: Remove unneeded apt stuff
      apt:
        autoremove: yes
        # Need the force_apt_get until
        # https://github.com/ansible/ansible/issues/56832
        force_apt_get: yes

    - name: Rebooting hosts
      reboot:
        msg: "Pis are being rebooted, update your inventory file with the new IPs before continuing"
        reboot_timeout: 5
      ignore_errors: true
